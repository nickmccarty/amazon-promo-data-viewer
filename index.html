<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amazon Promo Data Viewer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-5">
  <h1 class="text-center mb-4">Amazon Promo Data Viewer</h1>

  <div class="d-flex justify-content-between mb-3">
    <input type="text" class="form-control w-50" id="search" placeholder="ðŸ” Search...">
    <label>
      <input type="checkbox" onclick="toggleDarkMode()"> ðŸŒ™ Dark Mode
    </label>
  </div>

  <div id="loading" class="text-center my-4">
    <div class="spinner-border text-primary" role="status"></div>
    <p>Loading...</p>
  </div>

  <div id="table" class="table-responsive"></div>
</div>

<script src="https://unpkg.com/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>
<script>
  const sheetURL = "https://docs.google.com/spreadsheets/d/1ROUd1OEyQ_AQKN7x9e88U6Q9rQDzs2xpO6IYeqauEqQ/gviz/tq?tqx=out:csv&sheet=All%20Promos";
  const loading = document.getElementById("loading");
  const searchInput = document.getElementById("search");
  let table;

  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const response = await fetch(sheetURL);
      const csv = await response.text();
      const rows = parseCSV(csv);
      const headers = rows[0];
      const data = rows.slice(1).map(row => {
        const obj = {};
        headers.forEach((header, index) => {
          obj[header] = row[index] || "";
        });
        return obj;
      });

      table = new Tabulator("#table", {
        data: data,
        layout: "fitColumns",
        pagination: "local",
        paginationSize: 5,
        columns: headers.map(header => ({
          title: header,
          field: header,
          sorter: "string",
          headerFilter: "input"
        }))
      });

      searchInput.addEventListener("keyup", () => {
        table.setFilter((row) =>
          Object.values(row.getData()).some(value =>
            value.toString().toLowerCase().includes(searchInput.value.toLowerCase())
          )
        );
      });

    } catch (error) {
      console.error("Failed to fetch data:", error);
      document.querySelector("#table").innerHTML = `<p class="text-center text-danger">Failed to load data</p>`;
    } finally {
      loading.style.display = "none";
    }
  });

  function parseCSV(csv) {
    const lines = csv.split("\n");
    return lines.map(line =>
      line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)?.map(cell =>
        cell.replace(/^"|"$/g, "").trim()
      ) || []
    );
  }

  function toggleDarkMode() {
    document.body.classList.toggle("bg-dark");
    document.body.classList.toggle("text-white");
    document.querySelector(".tabulator").classList.toggle("tabulator-dark");
  }
</script>

</body>
</html>
